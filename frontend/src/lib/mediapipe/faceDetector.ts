import {
  FilesetResolver,
  FaceLandmarker,
  FaceLandmarkerResult,
} from '@mediapipe/tasks-vision'

let faceLandmarker: FaceLandmarker | null = null
let isInitializing = false

export async function initializeFaceDetector(): Promise<FaceLandmarker> {
  if (faceLandmarker) {
    return faceLandmarker
  }

  if (isInitializing) {
    while (isInitializing) {
      await new Promise(resolve => setTimeout(resolve, 100))
    }
    if (faceLandmarker) return faceLandmarker
  }

  isInitializing = true

  try {
    const vision = await FilesetResolver.forVisionTasks(
      'https://cdn.jsdelivr.net/npm/@mediapipe/tasks-vision@latest/wasm'
    )

    faceLandmarker = await FaceLandmarker.createFromOptions(vision, {
      baseOptions: {
        modelAssetPath: 'https://storage.googleapis.com/mediapipe-models/face_landmarker/face_landmarker/float16/1/face_landmarker.task',
        delegate: 'GPU',
      },
      runningMode: 'VIDEO',
      numFaces: 1,
      minFaceDetectionConfidence: 0.5,
      minFacePresenceConfidence: 0.5,
      minTrackingConfidence: 0.5,
      outputFaceBlendshapes: false,
      outputFacialTransformationMatrixes: false,
    })

    return faceLandmarker
  } finally {
    isInitializing = false
  }
}

export function detectFace(
  video: HTMLVideoElement,
  timestamp: number
): FaceLandmarkerResult | null {
  if (!faceLandmarker) return null

  try {
    return faceLandmarker.detectForVideo(video, timestamp)
  } catch {
    return null
  }
}

export function closeFaceDetector(): void {
  if (faceLandmarker) {
    faceLandmarker.close()
    faceLandmarker = null
  }
}

// Face contour indices for outline (subset of 468 landmarks)
// These indices trace the face silhouette
export const FACE_OVAL_INDICES = [
  10, 338, 297, 332, 284, 251, 389, 356, 454, 323, 361, 288,
  397, 365, 379, 378, 400, 377, 152, 148, 176, 149, 150, 136,
  172, 58, 132, 93, 234, 127, 162, 21, 54, 103, 67, 109
]

// Eyebrow indices
export const LEFT_EYEBROW_INDICES = [276, 283, 282, 295, 285]
export const RIGHT_EYEBROW_INDICES = [46, 53, 52, 65, 55]

// Eye outline indices
export const LEFT_EYE_INDICES = [362, 382, 381, 380, 374, 373, 390, 249, 263, 466, 388, 387, 386, 385, 384, 398]
export const RIGHT_EYE_INDICES = [33, 7, 163, 144, 145, 153, 154, 155, 133, 173, 157, 158, 159, 160, 161, 246]

// Lips outline indices
export const LIPS_OUTER_INDICES = [
  61, 146, 91, 181, 84, 17, 314, 405, 321, 375, 291, 308, 324, 318, 402, 317, 14, 87, 178, 88, 95
]

// Nose outline
export const NOSE_INDICES = [1, 2, 98, 327, 4, 5, 195, 197]

// Ear indices (approximate positions on face mesh)
export const LEFT_EAR_INDEX = 234
export const RIGHT_EAR_INDEX = 454

// Complete Face Mesh Tessellation - Full grid of triangular connections
// Based on MediaPipe's FACEMESH_TESSELATION (covers the entire face)
export const FACE_MESH_TESSELATION: [number, number][] = [
  // Forehead region
  [127, 34], [34, 139], [139, 127], [11, 0], [0, 37], [37, 11], [232, 231], [231, 120], [120, 232],
  [72, 37], [37, 39], [39, 72], [128, 121], [121, 47], [47, 128], [232, 121], [121, 128], [128, 232],
  [104, 69], [69, 67], [67, 104], [175, 171], [171, 148], [148, 175], [118, 50], [50, 101], [101, 118],
  [73, 39], [39, 40], [40, 73], [9, 151], [151, 108], [108, 9], [48, 115], [115, 131], [131, 48],
  [194, 211], [211, 204], [204, 194], [74, 40], [40, 185], [185, 74], [80, 42], [42, 183], [183, 80],
  [40, 92], [92, 186], [186, 40], [230, 229], [229, 118], [118, 230], [202, 212], [212, 214], [214, 202],
  [83, 18], [18, 17], [17, 83], [76, 61], [61, 146], [146, 76], [160, 29], [29, 30], [30, 160],
  [56, 157], [157, 173], [173, 56], [106, 204], [204, 194], [194, 106], [135, 214], [214, 192], [192, 135],
  [203, 165], [165, 98], [98, 203], [21, 71], [71, 68], [68, 21], [51, 45], [45, 4], [4, 51],
  [144, 24], [24, 23], [23, 144], [77, 146], [146, 91], [91, 77], [205, 50], [50, 187], [187, 205],
  [201, 200], [200, 18], [18, 201], [91, 106], [106, 182], [182, 91], [90, 91], [91, 181], [181, 90],
  [85, 84], [84, 17], [17, 85], [206, 203], [203, 36], [36, 206], [148, 171], [171, 140], [140, 148],
  [92, 40], [40, 39], [39, 92], [193, 189], [189, 244], [244, 193], [159, 158], [158, 28], [28, 159],
  [247, 246], [246, 161], [161, 247], [236, 3], [3, 196], [196, 236], [54, 68], [68, 104], [104, 54],
  [193, 168], [168, 8], [8, 193], [117, 228], [228, 31], [31, 117], [189, 193], [193, 55], [55, 189],
  [98, 97], [97, 99], [99, 98], [126, 47], [47, 100], [100, 126], [166, 79], [79, 218], [218, 166],
  [155, 154], [154, 26], [26, 155], [209, 49], [49, 131], [131, 209], [135, 136], [136, 150], [150, 135],
  [47, 126], [126, 217], [217, 47], [223, 52], [52, 53], [53, 223], [45, 51], [51, 134], [134, 45],
  [211, 170], [170, 140], [140, 211], [67, 69], [69, 108], [108, 67], [43, 106], [106, 91], [91, 43],
  [230, 119], [119, 120], [120, 230], [226, 130], [130, 247], [247, 226], [63, 53], [53, 52], [52, 63],
  [238, 20], [20, 242], [242, 238], [46, 70], [70, 156], [156, 46], [78, 62], [62, 96], [96, 78],
  [46, 53], [53, 63], [63, 46], [143, 34], [34, 227], [227, 143], [123, 117], [117, 111], [111, 123],
  [44, 125], [125, 19], [19, 44], [236, 134], [134, 51], [51, 236], [216, 206], [206, 205], [205, 216],
  [154, 153], [153, 22], [22, 154], [39, 37], [37, 167], [167, 39], [200, 201], [201, 208], [208, 200],
  [36, 142], [142, 100], [100, 36], [57, 212], [212, 202], [202, 57], [20, 60], [60, 99], [99, 20],
  [28, 158], [158, 157], [157, 28], [35, 226], [226, 113], [113, 35], [160, 159], [159, 27], [27, 160],
  [204, 202], [202, 210], [210, 204], [113, 225], [225, 46], [46, 113], [43, 202], [202, 204], [204, 43],
  [62, 76], [76, 77], [77, 62], [137, 123], [123, 116], [116, 137], [41, 38], [38, 72], [72, 41],
  [203, 129], [129, 142], [142, 203], [64, 98], [98, 240], [240, 64], [49, 102], [102, 64], [64, 49],
  [41, 73], [73, 74], [74, 41], [212, 216], [216, 207], [207, 212], [42, 74], [74, 184], [184, 42],
  [169, 170], [170, 211], [211, 169], [170, 149], [149, 176], [176, 170], [105, 66], [66, 69], [69, 105],
  [122, 6], [6, 168], [168, 122], [123, 147], [147, 187], [187, 123], [96, 77], [77, 90], [90, 96],
  [65, 55], [55, 107], [107, 65], [89, 90], [90, 180], [180, 89], [101, 100], [100, 120], [120, 101],
  [63, 105], [105, 104], [104, 63], [93, 137], [137, 227], [227, 93], [15, 86], [86, 85], [85, 15],
  [129, 102], [102, 49], [49, 129], [14, 87], [87, 86], [86, 14], [55, 8], [8, 9], [9, 55],
  [100, 47], [47, 121], [121, 100], [145, 23], [23, 22], [22, 145], [88, 89], [89, 179], [179, 88],
  [6, 122], [122, 196], [196, 6], [88, 95], [95, 96], [96, 88], [138, 172], [172, 136], [136, 138],
  [215, 58], [58, 172], [172, 215], [115, 48], [48, 219], [219, 115], [42, 80], [80, 81], [81, 42],
  [195, 3], [3, 51], [51, 195], [43, 146], [146, 61], [61, 43], [171, 175], [175, 199], [199, 171],
  [81, 82], [82, 38], [38, 81], [53, 46], [46, 225], [225, 53], [144, 163], [163, 110], [110, 144],
  [52, 65], [65, 66], [66, 52], [229, 228], [228, 117], [117, 229], [34, 127], [127, 234], [234, 34],
  [107, 108], [108, 69], [69, 107], [109, 108], [108, 151], [151, 109], [48, 64], [64, 235], [235, 48],
  [62, 78], [78, 191], [191, 62], [129, 209], [209, 126], [126, 129], [111, 35], [35, 143], [143, 111],
  [117, 123], [123, 50], [50, 117], [222, 65], [65, 52], [52, 222], [19, 94], [94, 141], [141, 19],
  [141, 94], [94, 125], [125, 141], [33, 7], [7, 163], [163, 33], [176, 149], [149, 150], [150, 176],
  [194, 106], [106, 43], [43, 194], [64, 102], [102, 240], [240, 64], [79, 166], [166, 59], [59, 79],
  [178, 87], [87, 14], [14, 178], [183, 42], [42, 81], [81, 183],

  // Right side of face (mirrored)
  [356, 264], [264, 368], [368, 356], [11, 0], [0, 267], [267, 11], [452, 451], [451, 349], [349, 452],
  [302, 267], [267, 269], [269, 302], [357, 350], [350, 277], [277, 357], [452, 350], [350, 357], [357, 452],
  [333, 299], [299, 297], [297, 333], [399, 400], [400, 377], [377, 399], [347, 280], [280, 330], [330, 347],
  [303, 269], [269, 270], [270, 303], [9, 151], [151, 337], [337, 9], [278, 344], [344, 360], [360, 278],
  [418, 431], [431, 424], [424, 418], [304, 270], [270, 409], [409, 304], [310, 272], [272, 407], [407, 310],
  [270, 322], [322, 410], [410, 270], [450, 449], [449, 347], [347, 450], [422, 432], [432, 434], [434, 422],
  [313, 18], [18, 17], [17, 313], [306, 291], [291, 375], [375, 306], [389, 259], [259, 260], [260, 389],
  [286, 386], [386, 398], [398, 286], [335, 424], [424, 418], [418, 335], [364, 434], [434, 416], [416, 364],
  [423, 391], [391, 327], [327, 423], [251, 301], [301, 298], [298, 251], [281, 275], [275, 4], [4, 281],
  [373, 254], [254, 253], [253, 373], [307, 375], [375, 321], [321, 307], [425, 280], [280, 411], [411, 425],
  [421, 200], [200, 18], [18, 421], [321, 335], [335, 406], [406, 321], [320, 321], [321, 405], [405, 320],
  [315, 314], [314, 17], [17, 315], [426, 423], [423, 266], [266, 426], [377, 400], [400, 369], [369, 377],
  [322, 270], [270, 269], [269, 322], [417, 413], [413, 464], [464, 417], [388, 387], [387, 258], [258, 388],
  [467, 466], [466, 390], [390, 467], [456, 3], [3, 420], [420, 456], [284, 298], [298, 333], [333, 284],
  [417, 168], [168, 8], [8, 417], [346, 448], [448, 261], [261, 346], [413, 417], [417, 285], [285, 413],
  [327, 326], [326, 328], [328, 327], [355, 277], [277, 329], [329, 355], [392, 309], [309, 438], [438, 392],
  [384, 383], [383, 256], [256, 384], [429, 279], [279, 360], [360, 429], [364, 365], [365, 379], [379, 364],
  [277, 355], [355, 437], [437, 277], [443, 282], [282, 283], [283, 443], [275, 281], [281, 363], [363, 275],
  [431, 395], [395, 369], [369, 431], [297, 299], [299, 337], [337, 297], [273, 335], [335, 321], [321, 273],
  [450, 348], [348, 349], [349, 450], [446, 359], [359, 467], [467, 446], [293, 283], [283, 282], [282, 293],
  [458, 250], [250, 462], [462, 458], [276, 300], [300, 385], [385, 276], [308, 292], [292, 325], [325, 308],
  [276, 283], [283, 293], [293, 276], [372, 264], [264, 447], [447, 372], [352, 346], [346, 340], [340, 352],
  [274, 354], [354, 19], [19, 274], [456, 363], [363, 281], [281, 456], [436, 426], [426, 425], [425, 436],
  [383, 382], [382, 252], [252, 383], [269, 267], [267, 393], [393, 269], [200, 421], [421, 428], [428, 200],
  [266, 371], [371, 329], [329, 266], [287, 432], [432, 422], [422, 287], [250, 290], [290, 328], [328, 250],
  [258, 387], [387, 386], [386, 258], [265, 446], [446, 342], [342, 265], [389, 388], [388, 257], [257, 389],
  [424, 422], [422, 430], [430, 424], [342, 445], [445, 276], [276, 342], [273, 422], [422, 424], [424, 273],
  [292, 306], [306, 307], [307, 292], [366, 352], [352, 345], [345, 366], [271, 268], [268, 302], [302, 271],
  [423, 358], [358, 371], [371, 423], [294, 327], [327, 460], [460, 294], [279, 331], [331, 294], [294, 279],
  [271, 303], [303, 304], [304, 271], [432, 436], [436, 427], [427, 432], [272, 304], [304, 408], [408, 272],
  [394, 395], [395, 431], [431, 394], [395, 378], [378, 400], [400, 395], [334, 296], [296, 299], [299, 334],
  [351, 6], [6, 168], [168, 351], [352, 376], [376, 411], [411, 352], [325, 307], [307, 320], [320, 325],
  [295, 285], [285, 336], [336, 295], [319, 320], [320, 404], [404, 319], [330, 329], [329, 349], [349, 330],
  [293, 334], [334, 333], [333, 293], [323, 366], [366, 447], [447, 323], [16, 316], [316, 315], [315, 16],
  [358, 331], [331, 279], [279, 358], [14, 317], [317, 316], [316, 14], [285, 8], [8, 9], [9, 285],
  [329, 277], [277, 350], [350, 329], [374, 253], [253, 252], [252, 374], [318, 319], [319, 403], [403, 318],
  [6, 351], [351, 420], [420, 6], [318, 324], [324, 325], [325, 318], [367, 397], [397, 365], [365, 367],
  [435, 288], [288, 397], [397, 435], [344, 278], [278, 439], [439, 344], [272, 310], [310, 311], [311, 272],
  [195, 3], [3, 281], [281, 195], [273, 375], [375, 291], [291, 273], [396, 399], [399, 419], [419, 396],
  [311, 312], [312, 268], [268, 311], [283, 276], [276, 445], [445, 283], [373, 390], [390, 339], [339, 373],
  [282, 295], [295, 296], [296, 282], [449, 448], [448, 346], [346, 449], [264, 356], [356, 454], [454, 264],
  [336, 337], [337, 299], [299, 336], [338, 337], [337, 151], [151, 338], [278, 294], [294, 455], [455, 278],
  [292, 308], [308, 415], [415, 292], [358, 429], [429, 355], [355, 358], [340, 265], [265, 372], [372, 340],
  [346, 352], [352, 280], [280, 346], [442, 295], [295, 282], [282, 442], [19, 94], [94, 370], [370, 19],
  [370, 94], [94, 354], [354, 370], [263, 249], [249, 390], [390, 263], [400, 378], [378, 379], [379, 400],
  [418, 335], [335, 273], [273, 418], [294, 331], [331, 460], [460, 294], [309, 392], [392, 289], [289, 309],
  [402, 317], [317, 14], [14, 402], [407, 272], [272, 311], [311, 407],
]
